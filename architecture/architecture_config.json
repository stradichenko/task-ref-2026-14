{
  "title": "DM1 Prospective Data Collection Platform — Architecture Map",
  "subtitle": "FOSS · Local-First · GDPR/EHDS · FHIR + OMOP CDM",
  "zones": [
    {
      "id": "client",
      "label": "Client Zone",
      "colour": "#E3F2FD",
      "border": "#1565C0",
      "components": [
        {
          "id": "mobile_app",
          "label": "Patient Mobile App",
          "sublabel": "Flutter / React Native",
          "icon": "MOB",
          "detail": "Offline-first · Encrypted SQLite\nSave-and-return · Accessible UI"
        },
        {
          "id": "clinician_portal",
          "label": "Clinician Portal",
          "sublabel": "React + TypeScript",
          "icon": "WEB",
          "detail": "Site-scoped views\nQuery management\nAdherence dashboards"
        },
        {
          "id": "dm_console",
          "label": "Data Manager Console",
          "sublabel": "React + TypeScript",
          "icon": "CFG",
          "detail": "Form config · Edit checks\nData locks · ETL control"
        }
      ]
    },
    {
      "id": "gateway_iam",
      "label": "API & Identity Zone",
      "colour": "#F3E5F5",
      "border": "#7B1FA2",
      "components": [
        {
          "id": "api_gateway",
          "label": "API Gateway",
          "sublabel": "Traefik / NGINX",
          "icon": "GW",
          "detail": "TLS termination\nJWT verification\nRate limiting"
        },
        {
          "id": "app_services",
          "label": "Application Services",
          "sublabel": "FastAPI / NestJS",
          "icon": "API",
          "detail": "FHIR R4 validation\nEdit checks · Consent check\nBusiness logic"
        },
        {
          "id": "keycloak",
          "label": "Keycloak IAM",
          "sublabel": "OpenID Connect / OAuth 2.0",
          "icon": "IAM",
          "detail": "RBAC · MFA · Site claims\nToken-based auth\nConsent-scoped access"
        }
      ]
    },
    {
      "id": "operational",
      "label": "Operational Data Zone",
      "colour": "#FFF8E1",
      "border": "#F57F17",
      "components": [
        {
          "id": "clinical_db",
          "label": "Clinical Data Store",
          "sublabel": "PostgreSQL (Pseudonymised)",
          "icon": "DB",
          "detail": "Pseudonymous IDs only\nAppend-only audit trail\nData locking · pgcrypto"
        },
        {
          "id": "identity_store",
          "label": "Identity Store",
          "sublabel": "PostgreSQL (Segmented)",
          "icon": "ID",
          "detail": "Network-segmented\nDirect identifiers only\nRestricted access"
        }
      ]
    },
    {
      "id": "processing",
      "label": "Processing & ETL Zone",
      "colour": "#EDE7F6",
      "border": "#512DA8",
      "components": [
        {
          "id": "deidentification",
          "label": "De-identification Pipeline",
          "sublabel": "Airflow / Prefect",
          "icon": "ETL",
          "detail": "Consent-gated transforms\nVersion-controlled DAGs\nFull provenance metadata"
        },
        {
          "id": "etl_mapping",
          "label": "FHIR → OMOP Mapping",
          "sublabel": "WhiteRabbit / Usagi / ETL",
          "icon": "MAP",
          "detail": "Vocabulary resolution\nConcept mapping (Athena)\nUnmapped value flagging"
        }
      ]
    },
    {
      "id": "research",
      "label": "Research & Analytics Zone",
      "colour": "#E8F5E9",
      "border": "#2E7D32",
      "components": [
        {
          "id": "omop_warehouse",
          "label": "OMOP CDM Warehouse",
          "sublabel": "PostgreSQL + OHDSI WebAPI",
          "icon": "CDM",
          "detail": "Isolated database\nOHDSI Achilles / DQD\nTime-limited access"
        },
        {
          "id": "atlas",
          "label": "OHDSI Atlas",
          "sublabel": "Cohort Definition & Studies",
          "icon": "ATL",
          "detail": "Point-and-click cohorts\nJSON export · Pathways\nIncidence & estimation"
        },
        {
          "id": "analytics_env",
          "label": "Analytics Environments",
          "sublabel": "JupyterLab / RStudio Server",
          "icon": "LAB",
          "detail": "Nix-managed deps\nRead-only credentials\nLogged queries"
        }
      ]
    },
    {
      "id": "external",
      "label": "External & Interoperability Zone",
      "colour": "#ECEFF1",
      "border": "#455A64",
      "components": [
        {
          "id": "fhir_facade",
          "label": "FHIR Facade",
          "sublabel": "HL7 FHIR R4 API",
          "icon": "FHIR",
          "detail": "12 DM1-specific profiles\nStandard terminology\nInterop endpoint"
        },
        {
          "id": "registries",
          "label": "Registries & Networks",
          "sublabel": "EURO-NMD / Orphanet / HPO",
          "icon": "REG",
          "detail": "ORPHA:273 alignment\nCross-border sharing\nData sharing agreements"
        },
        {
          "id": "ehds",
          "label": "EHDS Secondary Use",
          "sublabel": "European Health Data Space",
          "icon": "EU",
          "detail": "Transparency logging\nPurpose-bound access\nMinimum necessary"
        }
      ]
    }
  ],
  "connections": [
    {"from": "mobile_app",       "to": "api_gateway",      "label": "HTTPS + TLS 1.2+",  "number": 1},
    {"from": "clinician_portal", "to": "api_gateway",      "label": "HTTPS + TLS 1.2+",  "number": 1},
    {"from": "dm_console",       "to": "api_gateway",      "label": "HTTPS + TLS 1.2+",  "number": 1},
    {"from": "api_gateway",      "to": "keycloak",         "label": "Token validation",   "number": 2},
    {"from": "api_gateway",      "to": "app_services",     "label": "Validated request",  "number": 3},
    {"from": "app_services",     "to": "clinical_db",      "label": "Pseudonymised write","number": 4},
    {"from": "app_services",     "to": "identity_store",   "label": "ID resolution",      "number": 4},
    {"from": "clinical_db",      "to": "deidentification", "label": "Operational data",   "number": 5},
    {"from": "deidentification", "to": "etl_mapping",      "label": "De-identified data", "number": 6},
    {"from": "etl_mapping",      "to": "omop_warehouse",   "label": "OMOP load",          "number": 7},
    {"from": "omop_warehouse",   "to": "atlas",            "label": "WebAPI",             "number": 8},
    {"from": "omop_warehouse",   "to": "analytics_env",    "label": "Read-only SQL",      "number": 8},
    {"from": "fhir_facade",      "to": "app_services",     "label": "FHIR R4",            "number": 9},
    {"from": "omop_warehouse",   "to": "registries",       "label": "Governed export",    "number": 10},
    {"from": "omop_warehouse",   "to": "ehds",             "label": "Secondary use",      "number": 10}
  ],
  "zone_order": ["client", "gateway_iam", "operational", "processing", "research", "external"],
  "sidebars": {
    "left": {
      "label": "Identity & Access\nManagement",
      "sublabel": "Keycloak · OpenID Connect\nOAuth 2.0 · RBAC · MFA",
      "colour": "#FFF3E0",
      "border": "#E65100"
    },
    "right": {
      "label": "Observability\nAudit & Compliance",
      "sublabel": "Prometheus · Grafana\nLoki · Audit Log",
      "colour": "#FFEBEE",
      "border": "#C62828"
    }
  },
  "legend_groups": [
    {"label": "Client",           "colour": "#E3F2FD", "border": "#1565C0"},
    {"label": "API & Identity",   "colour": "#F3E5F5", "border": "#7B1FA2"},
    {"label": "Operational Data", "colour": "#FFF8E1", "border": "#F57F17"},
    {"label": "Processing & ETL", "colour": "#EDE7F6", "border": "#512DA8"},
    {"label": "Research",         "colour": "#E8F5E9", "border": "#2E7D32"},
    {"label": "External",         "colour": "#ECEFF1", "border": "#455A64"},
    {"label": "Cross-cutting",    "colour": "#FFEBEE", "border": "#C62828"}
  ]
}
